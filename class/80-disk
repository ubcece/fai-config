#!/bin/bash

[ $do_init_tasks -eq 1 ] || exit 0 # Only continue when doing install (not a dirinstall)

. /usr/lib/fai/subroutines         # For definition of ifclass

disksizes() {
	# Output the size of each disk, in kiB, in the natural enumeration order
	/usr/lib/fai/fai-disk-info | while read dev ; do
		awk -v dev="$dev" '$4 == dev { print $3 }' /proc/partitions
	done
}

if ifclass UBUNTU; then
    echo "UBUNTU_32G" && exit 0

elif ifclass SERVER ; then
	# FIXME: It would be nice if all servers could use a common layout and this line could go away.
	( ifclass VM_HOST || ifclass DATABASE ) && exit 0

	# On SERVERs, assume that we want to install to the first disk.
	size=`disksizes | head -n 1`

	[ "$size" -lt 10000000 ] && die "The hard disk is too small (10 GB minimum)."
        [ "$size" -ge 10000000 ] && [ "$size" -lt  35000000 ] && echo "TINYS" && exit 0
	if [ "$size" -ge 35000000 ] && [ "$size" -lt  70000000 ] ; then
		if ifclass RAID ; then
			echo "RAID1SS" && exit 0
		else
			echo "SMALLS" && exit 0
		fi
	fi
	if [ "$size" -ge 70000000 ] && [ "$size" -lt 500000000 ] ; then
		if ifclass RAID ; then
			echo "RAID1MS" && exit 0
		else
			echo "MEDIUMS" && exit 0
		fi
	fi
	echo "HUGE" # It would be wasteful to use 2TB disks in raid1, wouldn't it?
	exit 0
else
        [ `/usr/lib/fai/fai-disk-info | wc -l` -gt 2 ] && die "Too many hard disks. Too risky."
	# On non-SERVERs, assume that we want to install to the last disk.
	size=`disksizes | tail -n 1`

        if ifclass ECE_DISK2 ; then
		[ "$size" -lt 10000000 ] && die "The hard disk is too small (10 GB minimum)."
        	[ "$size" -ge 10000000 ] && [ "$size" -lt  35000000 ] && echo "TINYW" && exit 0
        	[ "$size" -ge 35000000 ] && [ "$size" -lt  70000000 ] && echo "SMALLW2" && exit 0
        	[ "$size" -ge 70000000 ] && [ "$size" -lt 500000000 ] && echo "MEDIUMW2" && exit 0
        	echo "HUGE2"
        	exit 0
	else
		[ "$size" -lt 10000000 ] && die "The hard disk is too small (10 GB minimum)."
        	[ "$size" -ge 10000000 ] && [ "$size" -lt  35000000 ] && echo "TINYW" && exit 0
        	[ "$size" -ge 35000000 ] && [ "$size" -lt  70000000 ] && echo "SMALLW" && exit 0
        	[ "$size" -ge 70000000 ] && [ "$size" -lt 500000000 ] && echo "MEDIUMW" && exit 0
        	echo "HUGE"
        	exit 0
	fi
fi
