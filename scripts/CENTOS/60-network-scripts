#! /bin/bash

error=0 ; trap "error=$((error|1))" ERR

# Note: Kudzu will automatically configure eth0 for DHCP
case "$FAI_ACTION" in
  install|dirinstall)
    (
        echo "# generated by FAI"
        echo "DEVICE=$NIC1"
        echo "HWADDR=`ip l sh dev eth0 | tail -1 | cut -d" " -f6`"
        echo "ONBOOT=yes"
        if ifclass DHCPC ; then
            echo "BOOTPROTO=dhcp"
        else
            echo "BOOTPROTO=static"
            echo "IPADDR=$IPADDR"
            read -r -a DNS <<< "$DNSSRVS"
            for i in "${!DNS[@]}"; do
                echo "DNS$(( $i + 1 ))=${DNS[i]}"
            done
        fi
    ) > $target/etc/sysconfig/network-scripts/ifcfg-"$NIC1"

    if ! ifclass DHCPC; then
        ainsl -v /etc/sysconfig/network "^GATEWAY=$GATEWAYS_1\$"
    fi

    # Kudzu for some reason won't write eth0 into /etc/sysconfig/hwconf
    # from within the chroot. The following hack puts it in there
    # so that Kudzu doesn't overwrite our config on first boot.
    if [ -f $target/sbin/kudzu ]; then
        grep eth0 $target/etc/sysconfig/hwconf || $ROOTCMD kudzu -c NETWORK -p \
        >> $target/etc/sysconfig/hwconf
    fi
    ;;
esac

fcopy -iv /etc/sysconfig/network /etc/resolv.conf /etc/networks
fcopy -ivr /etc/sysconfig/network-scripts

exit $error
