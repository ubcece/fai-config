--- /usr/sbin/fai-chboot.template	2013-02-01 20:50:21.000000000 +0000
+++ /usr/sbin/fai-chboot	2013-05-06 01:01:35.217171032 +0000
@@ -318,9 +318,20 @@
 sub docopy {
 
-  my ($srcfile, $pxedir, $desthex, $desthost, $ipadr) = @_;
+  my ($srcfile, $pxedir, $desthex, $desthost, $ipadr, $tmpl_subst_params) = @_;
   open (SOURCE, "$srcfile");
   open (DEST, ">$pxedir/$desthex") || die "Can't opendir $pxedir: $!";
   print DEST "# template generated by fai-chboot for host $desthost with IP $ipadr from source $srcfile\n";
   while (<SOURCE>) {
+    s/\$(\$)|(\$\{(.+?)(?::=([^}]*))?\}|\$(\w+))/
+         $1 ?
+             '' :                                          # Two consecutive $ -> One literal $
+         defined $3 && exists $tmpl_subst_params->{$3} ?
+             $tmpl_subst_params->{$3} :                    # ${var} -> val if var=val is specified
+         defined $3 && defined $4 ?
+             $4 :                                          # ${var:=default} -> default if var is unspecified
+         defined $5 && exists $tmpl_subst_params->{$5} ?
+             $tmpl_subst_params->{$5} :                    # $var -> val if var=val is specified
+             $2;                                           # Leave ${var} and $var unchanged if var is unspecified
+     /eg;
     print DEST $_;
   }
@@ -331,5 +342,5 @@
 sub tcopy {
 
-  my ($srchost,$desthost) = @_;
+  my ($srchost,$desthost,$tmpl_subst_params) = @_;
   my ($ipadr,$srcfile,$srchex,$desthex);
 
@@ -363,5 +374,5 @@
     }
     print "copy pxe config from $srchost to template $desthost\n" if $verbose;
-    docopy($srcfile,$pxedir,$desthost,$desthost,$ipadr);
+    docopy($srcfile,$pxedir,$desthost,$desthost,$ipadr,$tmpl_subst_params);
   } else {
     ($ipadr,$desthex) = host2hex($desthost);
@@ -371,5 +382,5 @@
     }
     print "copy pxe config from $srchost to $desthost ($desthex)\n" if $verbose;
-    docopy($srcfile,$pxedir,$desthex,$desthost,$ipadr);
+    docopy($srcfile,$pxedir,$desthex,$desthost,$ipadr,$tmpl_subst_params);
   }
 }
@@ -415,6 +426,8 @@
   die "Missing destination host name(s). Can't copy.\n" unless @ARGV;
   # copy a template config to multiple hosts
-  foreach (@ARGV) {
-    tcopy($opt_c,$_);
+  my @dests = grep !/.=/, @ARGV;
+  my %parms = map { /([^=]+)=(.*)/ } grep /.=/, @ARGV;
+  foreach (@dests) {
+    tcopy($opt_c,$_,\%parms);
   }
   $error and die "$0: $error\n";
